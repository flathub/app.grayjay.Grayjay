app-id: app.grayjay.Grayjay
runtime: org.freedesktop.Platform
runtime-version: '24.08'
sdk: org.freedesktop.Sdk

command: Grayjay
finish-args:
  - --share=network
  - --socket=pulseaudio
  - --socket=wayland
  - --socket=fallback-x11
  - --share=ipc
  - --device=dri
  - --filesystem=xdg-download
  - --own-name=org.mpris.MediaPlayer2.chromium.*
  - --talk-name=org.freedesktop.ScreenSaver
  - --env=XCURSOR_PATH=/run/host/user-share/icons:/run/host/share/icons
sdk-extensions:
  - org.freedesktop.Sdk.Extension.dotnet8
  - org.freedesktop.Sdk.Extension.node22
  - org.freedesktop.Sdk.Extension.llvm18
build-options:
  prepend-path: /usr/lib/sdk/llvm18/bin:/usr/lib/sdk/dotnet8/bin:/usr/lib/sdk/node22/bin
  prefix: /usr/lib/sdk/llvm18:/usr/lib/sdk/dotnet8
  append-ld-library-path: /usr/lib/sdk/llvm18/lib:/usr/lib/sdk/dotnet8/lib
  prepend-pkg-config-path: /usr/lib/sdk/llvm18/pkgconfig/usr/lib/sdk/dotnet8/lib/pkgconfig
modules:
  - name: dotnet
    buildsystem: simple
    build-commands:
    - /usr/lib/sdk/dotnet8/bin/install.sh
  - name: dotcefnative
    buildsystem: simple
    build-commands:
      - mkdir -p native/build
      - cd native/build; cmake ..
      - cd native/build; cmake --build .
      # install/copy output?
    sources:
      - type: archive
        url: https://gitlab.futo.org/videostreaming/JustCef/-/archive/7f4271984afdf69826c22bc84ae7a8b5a20081a8/JustCef.zip
        sha256: ed828785d3b04053edb86664cafe9940a42bf8015a0d2d4dce06ee4ee96819b3
      - type: patch
        path: patches/cef-nodownload-clangformat.patch
      # - type: file
      #   # https://stackoverflow.com/a/70172000
      #   url: https://gitlab.futo.org/videostreaming/JustCef/-/raw/master/native/third_party/cef/cef_binary_140.1.20+g49f5d09+chromium-140.0.7339.214_linuxarm64_minimal.tar.bz2?inline=false
      #   sha256: 43941c3ef802144add90a0ddb741fa76abbdde52f07f310afc68f1c476d1d609
      #   dest: 'native/third_party/cef/'
      #   only-arches:
      #     - aarch64
      # - type: file
      #   # https://stackoverflow.com/a/70172000
      #   url: https://gitlab.futo.org/videostreaming/JustCef/-/raw/master/native/third_party/cef/cef_binary_140.1.20+g49f5d09+chromium-140.0.7339.214_linux64_minimal.tar.bz2?inline=false
      #   sha256: 92137d8aa55755a849b26aad2aa7ebbc5e21e8a3af267665f9ce9c42ff96f8e5
      #   dest: 'native/third_party/cef/'
      #   only-arches:
      #     - x86_64
  - name: grayjay
    buildsystem: simple
    build-options:
      env:
        # Set the cache directory, used to find Electron and some other helper
        # tools.
        # (The directory format is: /run/build/MODULE_NAME/flatpak-node/cache)
        XDG_CACHE_HOME: ${FLATPAK_BUILDER_BUILDDIR}/flatpak-node/cache
        # Set the npm cache directory, used by npm to find its package metadata.
        npm_config_cache: ${FLATPAK_BUILDER_BUILDDIR}/flatpak-node/npm-cache
    build-commands:
      - mkdir -p ${FLATPAK_DEST}/grayjay
      - ./deploy_flatpak.sh "${FLATPAK_DEST}/grayjay" "${FLATPAK_BUILDER_BUILDDIR}/nuget-sources"
      - dotnet nuget locals all --clear
      - install -Dm 0644 app.grayjay.Grayjay.desktop ${FLATPAK_DEST}/share/applications/app.grayjay.Grayjay.desktop
      - install -Dm 0644 app.grayjay.Grayjay.metainfo.xml  ${FLATPAK_DEST}/share/metainfo/app.grayjay.Grayjay.metainfo.xml
      - mkdir -p ${FLATPAK_DEST}/share/icons/hicolor/128x128/apps
      - ffmpeg -width 128 -i icon.svg -vf scale=128:-1 ${FLATPAK_DEST}/share/icons/hicolor/128x128/apps/app.grayjay.Grayjay.png
      - mkdir -p ${FLATPAK_DEST}/share/icons/hicolor/256x256/apps
      - ffmpeg -width 256 -i icon.svg -vf scale=256:-1 ${FLATPAK_DEST}/share/icons/hicolor/256x256/apps/app.grayjay.Grayjay.png
      - mkdir -p ${FLATPAK_DEST}/share/icons/hicolor/512x512/apps
      - ffmpeg -width 512 -i icon.svg -vf scale=512:-1 ${FLATPAK_DEST}/share/icons/hicolor/512x512/apps/app.grayjay.Grayjay.png
      - mkdir -p ${FLATPAK_DEST}/share/icons/hicolor/scalable/apps
      - cp icon.svg ${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/app.grayjay.Grayjay.svg
      - rm ${FLATPAK_DEST}/grayjay/Portable # https://github.com/futo-org/Grayjay.Desktop/issues/14#issuecomment-2692940623
      - rm ${FLATPAK_DEST}/grayjay/FUTO.Updater.Client
      - ln -s "${FLATPAK_DEST}/grayjay/Grayjay" "${FLATPAK_DEST}/bin/Grayjay" 

    sources:
      - type: git
        # use if developing locally, and adjust/remove branch/tag/commit below accordingly
        # url: file:///path/to/Grayjay.Desktop 
        url: https://gitlab.futo.org/videostreaming/Grayjay.Desktop.git
        commit: bf547a9ff9198f5c55d27ae8a25ef690ce97fd61
        disable-submodules: true
        # x-checker-data:
        #   type: git
        #   url: https://gitlab.futo.org/videostreaming/Grayjay.Desktop/-/tags
        #   tag-pattern: ^([\d]+)$
        #   is-main-source: true
      - submodule-sources.json

      - type: file
        path: deploy_flatpak.sh

      - npm-sources.json

      - nuget-sources.json
      - nuget-sources-syncsever.json

      - type: file
        path: icon.svg
