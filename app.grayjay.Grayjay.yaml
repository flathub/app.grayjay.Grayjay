app-id: app.grayjay.Grayjay
runtime: org.freedesktop.Platform
runtime-version: '25.08'
sdk: org.freedesktop.Sdk

command: Grayjay
finish-args:
  - --share=network
  - --socket=pulseaudio
  - --socket=wayland
  - --socket=fallback-x11
  - --share=ipc
  - --device=dri
  - --filesystem=xdg-download
  - --own-name=org.mpris.MediaPlayer2.chromium.*
  - --talk-name=org.freedesktop.ScreenSaver
  - --env=XCURSOR_PATH=/run/host/user-share/icons:/run/host/share/icons
sdk-extensions:
  - org.freedesktop.Sdk.Extension.dotnet8
  - org.freedesktop.Sdk.Extension.node22
  - org.freedesktop.Sdk.Extension.llvm20
cleanup-commands:
  - rm /app/bin/patchelf
  - rm -rf /app/build/curlshim
build-options:
  prepend-path: /usr/lib/sdk/llvm20/bin:/usr/lib/sdk/dotnet8/bin:/usr/lib/sdk/node22/bin
  prefix: /usr/lib/sdk/llvm20:/usr/lib/sdk/dotnet8
  append-ld-library-path: /usr/lib/sdk/llvm20/lib:/usr/lib/sdk/dotnet8/lib
  prepend-pkg-config-path: /usr/lib/sdk/llvm20/pkgconfig/usr/lib/sdk/dotnet8/lib/pkgconfig
modules:
  - name: dotnet
    buildsystem: simple
    build-commands:
    - /usr/lib/sdk/dotnet8/bin/install.sh
  # note: the builder should NOT hang after starting to build this module and printing some "is not a valid attribute name" git LFS errors. If it does this, you need to remove or disable the git LFS config from your ~/.gitconfig file.
  # see https://github.com/flatpak/flatpak-builder/blob/e2f9ffc4655e1f80e1ef2edf205942d59cc01fb7/doc/flatpak-manifest.xml#L776
  - name: dotcefnative
    buildsystem: simple
    build-commands:
      - mkdir -p native/build
      - cd native/build; cmake -DCMAKE_C_COMPILER=clang -DCMAKE_CXX_COMPILER=clang++ ..
      - cd native/build; cmake --build .
      - mkdir -p "${FLATPAK_DEST}/grayjay/cef"
      - mv native/build/Release/* "${FLATPAK_DEST}/grayjay/cef"
      - chmod +x "${FLATPAK_DEST}/grayjay/cef/dotcefnative"
    sources:
      - type: git
        url: https://gitlab.futo.org/videostreaming/JustCef.git
        commit: 6f57f785de518901c25c73ecfbccc15e77fb5e3f
        disable-submodules: true
        disable-lfs: true
      - type: patch
        path: patches/cef-nodownload-clangformat.patch
      - type: archive
        # https://stackoverflow.com/a/70172000
        
        url: https://gitlab.futo.org/videostreaming/JustCef/-/raw/master/native/third_party/cef/cef_binary_141.0.10+g1d65b0d+chromium-141.0.7390.123_linuxarm64_minimal.tar.bz2?inline=false
        sha256: 533b941af98b85971b0a21f3626ad97e611c55cad2783a1f2185593de6843b3a
        dest: 'native/third_party/cef/cef_binary_141.0.10+g1d65b0d+chromium-141.0.7390.123_linuxarm64_minimal'
        only-arches:
          - aarch64
      - type: archive
        # https://stackoverflow.com/a/70172000
        url: https://gitlab.futo.org/videostreaming/JustCef/-/raw/master/native/third_party/cef/cef_binary_141.0.10+g1d65b0d+chromium-141.0.7390.123_linux64_minimal.tar.bz2?inline=false
        sha256: b7df842e2f3d08c635d9dc230fb7f95a7ce3cafd45ae4da3e0c40638cc51bee8
        dest: 'native/third_party/cef/cef_binary_141.0.10+g1d65b0d+chromium-141.0.7390.123_linux64_minimal'
        only-arches:
          - x86_64
      - type: patch
        path: patches/fortify.patch
  - name: patchelf
    build-commands:
     - cp /run/build/patchelf/src/patchelf /app/bin/patchelf
    sources:
      - type: git
        url: https://github.com/NixOS/patchelf.git
        commit: a949ff23315bbb5863627c4655fe216ecbf341a2
  - name: curlshim
    buildsystem: simple
    build-commands:
      - ./curlbind/scripts/linux/build-imp-shim.sh
      - mkdir -p /app/build/curlshim
      - cp -r ./curlbind/out/* /app/build/curlshim
    sources:
      - type: file
        url: https://github.com/lexiforest/curl-impersonate/releases/download/v1.2.3/libcurl-impersonate-v1.2.3.x86_64-linux-gnu.tar.gz
        sha256: 56fd8d898ec5db120963ab6fa28683771e51204dc346d6f8bc53beebacb1cd4b
        dest-filename: libcurl-impersonate-linux-gnu.tar.gz
        only-arches:
          - x86_64
      - type: file
        url: https://github.com/lexiforest/curl-impersonate/releases/download/v1.2.3/libcurl-impersonate-v1.2.3.aarch64-linux-gnu.tar.gz
        sha256: 4fa79a3f0948904e32e69f62f5e1755f467101498718a8bb4c63480be8bfeddb
        dest-filename: libcurl-impersonate-linux-gnu.tar.gz
        only-arches:
          - aarch64
      - type: file
        path: build-imp-shim.sh
        dest: curlbind/scripts/linux
      - type: file
        path: curlshim.c
        dest: curlbind/native/desktop


  - name: grayjay
    buildsystem: simple
    build-options:
      env:
        # Set the cache directory, used to find Electron and some other helper
        # tools.
        # (The directory format is: /run/build/MODULE_NAME/flatpak-node/cache)
        XDG_CACHE_HOME: ${FLATPAK_BUILDER_BUILDDIR}/flatpak-node/cache
        # Set the npm cache directory, used by npm to find its package metadata.
        npm_config_cache: ${FLATPAK_BUILDER_BUILDDIR}/flatpak-node/npm-cache
    build-commands:
      - mkdir -p ${FLATPAK_DEST}/grayjay
      # build frontend
      - cd Grayjay.Desktop.Web; npm install --offline
      - cd Grayjay.Desktop.Web; npm run build
      - mkdir -p "${FLATPAK_DEST}/grayjay/wwwroot/web"
      - mv Grayjay.Desktop.Web/dist/* "${FLATPAK_DEST}/grayjay/wwwroot/web"
      # build core app
      - ./deploy_flatpak.sh "${FLATPAK_DEST}/grayjay" "${FLATPAK_BUILDER_BUILDDIR}/nuget-sources"
      # cleanup
      - dotnet nuget locals all --clear
      # Adjustments
      - chmod u=rwx ${FLATPAK_DEST}/grayjay/Grayjay
      - rm ${FLATPAK_DEST}/grayjay/ffmpeg # we provide ffmpeg already
      - rm ${FLATPAK_DEST}/grayjay/libcurl-impersonate.so ${FLATPAK_DEST}/grayjay/libcurlshim.so
      # these cp operations will copy the file, not the symlinks
      - cp /app/build/curlshim/libcurl-impersonate.so ${FLATPAK_DEST}/grayjay
      - cp /app/build/curlshim/libcurlshim.so ${FLATPAK_DEST}/grayjay
      - rm ${FLATPAK_DEST}/grayjay/Portable # https://github.com/futo-org/Grayjay.Desktop/issues/14#issuecomment-2692940623
      # - chmod u=rwx ${FLATPAK_DEST}/grayjay/FUTO.Updater.Client
      - rm ${FLATPAK_DEST}/grayjay/FUTO.Updater.Client ${FLATPAK_DEST}/grayjay/Updater*.json # updates managed by flatpak
      # install metadata, icons and other helper files
      - install -Dm 0644 app.grayjay.Grayjay.desktop ${FLATPAK_DEST}/share/applications/app.grayjay.Grayjay.desktop
      - install -Dm 0644 app.grayjay.Grayjay.metainfo.xml  ${FLATPAK_DEST}/share/metainfo/app.grayjay.Grayjay.metainfo.xml
      - mkdir -p ${FLATPAK_DEST}/share/icons/hicolor/128x128/apps
      - ffmpeg -width 128 -i icon.svg -vf scale=128:-1 ${FLATPAK_DEST}/share/icons/hicolor/128x128/apps/app.grayjay.Grayjay.png
      - mkdir -p ${FLATPAK_DEST}/share/icons/hicolor/256x256/apps
      - ffmpeg -width 256 -i icon.svg -vf scale=256:-1 ${FLATPAK_DEST}/share/icons/hicolor/256x256/apps/app.grayjay.Grayjay.png
      - mkdir -p ${FLATPAK_DEST}/share/icons/hicolor/512x512/apps
      - ffmpeg -width 512 -i icon.svg -vf scale=512:-1 ${FLATPAK_DEST}/share/icons/hicolor/512x512/apps/app.grayjay.Grayjay.png
      - mkdir -p ${FLATPAK_DEST}/share/icons/hicolor/scalable/apps
      - cp icon.svg ${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/app.grayjay.Grayjay.svg
      - ln -s "${FLATPAK_DEST}/grayjay/Grayjay" "${FLATPAK_DEST}/bin/Grayjay" 

    sources:
      - type: git
        # use if developing locally, and adjust/remove branch/tag/commit below accordingly
        # url: file:///path/to/Grayjay.Desktop 
        url: https://gitlab.futo.org/videostreaming/Grayjay.Desktop.git
        commit: 546b2dd3e8ce80db9b8ebf067322541ec9c41e45
        disable-lfs: true
        # x-checker-data:
        #   type: git
        #   url: https://gitlab.futo.org/videostreaming/Grayjay.Desktop/-/tags
        #   tag-pattern: ^([\d]+)$
        #   is-main-source: true

      - type: file
        path: deploy_flatpak.sh
      - type: file
        path: path.sh

      - npm-sources.json

      - nuget-sources.json
      - nuget-sources-arm.json

      # uncomment and adjust the file contents if needed
      # - type: patch
      #   path: patches/version.patch

      - type: patch
        path: patches/removeAot.patch
        options:
          - -dSyncServer

      - type: file
        path: icon.svg
